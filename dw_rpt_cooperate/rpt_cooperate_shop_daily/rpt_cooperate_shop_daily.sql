SET hive.mapred.supports.subdirectories=TRUE;
SET mapred.input.dir.recursive=TRUE;
set hive.exec.dynamic.partition =true;
set hive.exec.dynamic.partition.mode=nonstrict;
set hive.exec.max.dynamic.partitions.pernode=1000 ;
set hive.exec.max.dynamic.partitions=1000 ;
set hive.exec.max.created.files=1000 ;

drop table if exists temp.rpt_cooperate_shop_daily_temp0 ;
create table if not exists temp.rpt_cooperate_shop_daily_temp0 as select explode(split(CONCAT(date_sub('${hivevar:day}',1),',','${hivevar:day}'),',')) as stati_date ;

drop table if exists temp.rpt_cooperate_shop_daily_temp1 ;
create table if not exists temp.rpt_cooperate_shop_daily_temp1 as select * from rpt.rpt_cooperate_shop where `date`>=date_sub('${hivevar:day}',1) and `date`<='${hivevar:day}' ;

drop table if exists temp.rpt_cooperate_shop_daily_temp2 ;
create table if not exists temp.rpt_cooperate_shop_daily_temp2 as select `date` ,shop_id ,sum(allot_item_num) as allot_item_num ,sum(send_item_num) as send_item_num ,sum(return_item_num) as return_item_num ,sum(return_success_item_num) as return_success_item_num from rpt.rpt_cooperate_item_daily where `date`>=date_sub('${hivevar:day}',1) and `date`<='${hivevar:day}' group by `date`,shop_id ;

drop table if exists temp.rpt_cooperate_shop_daily_temp3 ;
create table if not exists temp.rpt_cooperate_shop_daily_temp3 as select t1.`date` ,t1.shop_id ,avg(t1.return_seconds) as return_seconds from (select distinct `date` ,return_batch_id ,shop_id ,return_seconds from dw.fct_cooperate_return_label where `date`>=date_sub('${hivevar:day}',1) and `date`<='${hivevar:day}') t1 group by t1.`date`,t1.shop_id ;

drop table if exists temp.rpt_cooperate_shop_daily_temp4 ;
create table if not exists temp.rpt_cooperate_shop_daily_temp4 as select t1.shop_id ,t1.shop_name ,t1.bid ,t1.market_name ,t1.lower_price ,t1.coo_shop_num ,t1.new_coo_shop_num ,t1.twice_coo_shop_num ,t1.exit_coo_shop_num ,t1.coo_days ,t1.`date` ,t2.allot_item_num ,t2.send_item_num ,t2.return_item_num ,t2.return_success_item_num ,t3.return_seconds from temp.rpt_cooperate_shop_daily_temp1 t1 left join temp.rpt_cooperate_shop_daily_temp2 t2 on t1.`date`=t2.`date` and t1.shop_id=t2.shop_id left join temp.rpt_cooperate_shop_daily_temp3 t3 on t1.`date`=t3.`date` and t1.shop_id=t3.shop_id ;

drop table if exists temp.rpt_cooperate_shop_daily_temp5 ;
create table if not exists temp.rpt_cooperate_shop_daily_temp5 as select cast(split(t1.`data`,'\\|')[0] as bigint) as shop_id ,cast(split(t1.data,'\\|')[1] as string) as shop_name ,cast(split(t1.data,'\\|')[2] as bigint) as bid ,cast(split(t1.data,'\\|')[3] as string) as market_name ,cast(split(t1.data,'\\|')[4] as double) as lower_price ,cast(split(t1.data,'\\|')[5] as bigint) as coo_shop_num ,cast(split(t1.data,'\\|')[6] as bigint) as new_coo_shop_num ,cast(split(t1.data,'\\|')[7] as bigint) as twice_coo_shop_num ,cast(split(t1.data,'\\|')[8] as bigint) as exit_coo_shop_num ,cast(split(t1.data,'\\|')[9] as bigint) as coo_days ,cast(split(t1.data,'\\|')[10] as bigint) as allot_item_num ,cast(split(t1.data,'\\|')[11] as bigint) as send_item_num ,cast(split(t1.data,'\\|')[12] as bigint) as return_item_num ,cast(split(t1.data,'\\|')[13] as bigint) as return_success_item_num ,cast(split(t1.data,'\\|')[14] as bigint) as return_seconds ,cast(split(t1.data,'\\|')[15] as string) as `date` from (select explode(split('||||1||||||31|25||||2019-09-10,||||1||||||75|70||||2019-09-11,||||1||||||59|54||||2019-09-12,||||||||||0|0||||2019-09-13,||||1||||||79|67||||2019-09-14,||||1||||||55|44||||2019-09-15,||||1||||||101|79||||2019-09-16,||||1||||||125|107||||2019-09-17,||||1||||||196|160||||2019-09-18,||||1||||||196|151||||2019-09-19,||||1||||||488|397||||2019-09-20,||||1||||||694|579||||2019-09-21,||||1||||||524|410||||2019-09-22,||||1||||||540|410||||2019-09-23,||||1||||||595|483||||2019-09-24,||||1||||||503|392||||2019-09-25,||||1||||||1004|823||||2019-09-26,||||1||||||1353|1080||||2019-09-27,||||1||||||1257|1011||||2019-09-28,||||1||||||997|799||||2019-09-29,||||1||||||851|709||||2019-09-30,||||||||||0|0||||2019-10-01,||||||||||0|0||||2019-10-02,||||||||||0|0||||2019-10-03,||||1||||||1903|1546||||2019-10-04,||||1||||||931|756||||2019-10-05,||||1||||||758|613||||2019-10-06,||||1||||||946|794||||2019-10-07,||||1||||||923|718||||2019-10-08,||||1||||||912|731||||2019-10-09,||||1||||||1125|929||||2019-10-10,||||1||||||1066|887||||2019-10-11,||||1||||||1086|840||||2019-10-12,||||1||||||789|682||||2019-10-13,||||1||||||1158|915||||2019-10-14,||||1||||||1362|1098||||2019-10-15,||||1||||||1422|1058||||2019-10-16,||||1||||||1868|1424||||2019-10-17,||||1||||||1483|1173||||2019-10-18,||||1||||||1678|1350||||2019-10-19,||||1||||||1459|1161||||2019-10-20,||||1||||||1415|1143||||2019-10-21,||||1||||||1349|987||||2019-10-22,||||0.9746||||||2206|1691||||2019-10-23,||||0.9988||||||2044|1658||||2019-10-24,||||0.9994||||||2078|1654||||2019-10-25,||||1||||||1609|1232||||2019-10-26,||||0.9981||||||2012|1585||||2019-10-27,||||1||||||2183|1644||||2019-10-28,||||1||||||2866|2217||||2019-10-29,||||1||||||3469|2628||||2019-10-30,||||1||||||3167|2406||||2019-10-31,||||1.0129||||||3124|2486||||2019-11-01,||||1.0091||||||2608|1980||||2019-11-02,||||1.0078||||||2592|2061||||2019-11-03,||||1.0182||||||2781|2196||||2019-11-04,||||1||||||2969|2242||||2019-11-05,||||1.0194||||||3438|2682||||2019-11-06,||||1.008||||||3273|2496||||2019-11-07,||||1.0088||||||3536|2725||||2019-11-08,||||1.0024||||||3335|2521||||2019-11-09,||||1.0146||||||3281|2464||||2019-11-10,||||1.0046||||||5517|3471||||2019-11-11,||||1.0042||||||7956|4713||||2019-11-12,||||1.0098||||||7403|4510||||2019-11-13,||||1.0028||||||6111|3572||||2019-11-14,||||1.018||||||6599|3230||||2019-11-15,||||1.0112||||||4997|3383||||2019-11-16,||||1.003||||||4207|2702||||2019-11-17,||||1.012||||||4460|3155||||2019-11-18,||||1.0031||||||4633|3245||||2019-11-19,||||1.0047||||||6035|4299||||2019-11-20,||||1.0065||||||6465|4641||||2019-11-21,||||1.0034||||||6617|4676||||2019-11-22,||||1.0074||||||6167|4336||||2019-11-23',',')) as data) t1 ;

drop table if exists temp.rpt_cooperate_shop_daily_temp6 ;
create table if not exists temp.rpt_cooperate_shop_daily_temp6 as select shop_id ,shop_name ,bid ,market_name ,lower_price ,coo_shop_num ,new_coo_shop_num ,twice_coo_shop_num ,exit_coo_shop_num ,coo_days ,allot_item_num ,send_item_num ,return_item_num ,return_success_item_num ,return_seconds ,`date` from temp.rpt_cooperate_shop_daily_temp5 union all select cast(shop_id as bigint) as shop_id ,shop_name ,bid ,market_name ,lower_price ,coo_shop_num ,new_coo_shop_num ,twice_coo_shop_num ,exit_coo_shop_num ,coo_days ,allot_item_num ,send_item_num ,return_item_num ,return_success_item_num ,return_seconds ,`date` from temp.rpt_cooperate_shop_daily_temp4 ;

drop table if exists temp.rpt_cooperate_shop_daily_temp7 ;
create table if not exists temp.rpt_cooperate_shop_daily_temp7 as select t1.* from temp.rpt_cooperate_shop_daily_temp6 t1 inner join temp.rpt_cooperate_shop_daily_temp0 t2 on t1.`date`=t2.stati_date ;

insert overwrite table rpt.rpt_cooperate_shop_daily partition(`date`) select shop_id ,shop_name ,bid ,market_name ,lower_price ,coo_shop_num ,new_coo_shop_num ,twice_coo_shop_num ,exit_coo_shop_num ,coo_days ,allot_item_num ,send_item_num ,return_item_num ,return_success_item_num ,return_seconds ,`date` from temp.rpt_cooperate_shop_daily_temp7 where `date`>=date_sub('${hivevar:day}',1) and `date`<'2021-01-10' ;

