-- 常规参数设置
SET hive.mapred.supports.subdirectories=TRUE;
SET mapred.input.dir.recursive=TRUE;
set hive.exec.dynamic.partition =true;
set hive.exec.dynamic.partition.mode=nonstrict;
set hive.exec.max.dynamic.partitions.pernode=1000 ;
set hive.exec.max.dynamic.partitions=1000 ;
set hive.exec.max.created.files=1000 ;
SET hive.execution.engine=tez;
SET hive.tez.container.size=1024;
SET hive.vectorized.execution.enabled=FALSE;

drop table if exists temp.dws_pangge_shop_allot_daily_temp0 ;
create table if not exists temp.dws_pangge_shop_allot_daily_temp0 as select '${hivevar:day}' as stati_date ;

drop table if exists temp.dws_pangge_shop_allot_daily_temp1 ;
create table if not exists temp.dws_pangge_shop_allot_daily_temp1 as select 'allot' as `indicator` ,`product_label_no` ,`date` from dwd.dwd_pangge_allot_label where `date`>='${hivevar:day}' and `date`<='${hivevar:day}' union all select 'enallot' as `indicator` ,`product_label_no` ,`date` from dwd.dwd_pangge_enallot_label where `date`>='${hivevar:day}' and `date`<='${hivevar:day}' union all select 'print' as `indicator` ,`product_label_no` ,`date` from dwd.dwd_pangge_print_label where `date`>='${hivevar:day}' and `date`<='${hivevar:day}' ;

drop table if exists temp.dws_pangge_shop_allot_daily_temp2 ;
create table if not exists temp.dws_pangge_shop_allot_daily_temp2 as select t3.* ,t4.`shop_id` ,t4.`city_market_id` ,t5.`bid` as `market_id` ,(case when t6.coo_shop_num is null then 0 else 1 end) as `is_coo_shop` from (select t1.* from temp.dws_pangge_shop_allot_daily_temp1 t1 inner join temp.dws_pangge_shop_allot_daily_temp0 t2 on t1.`date`=t2.`stati_date`) t3 left join dw.dim_wms_product_label t4 on t3.`product_label_no`=t4.`product_label_no` left join ods.t_shop t5 on t4.`shop_id`=t5.`id` left join (select * from dw.fct_cooperate_shop where `date`>='${hivevar:day}' and `date`<='${hivevar:day}' and `coo_shop_num`=1) t6 on t4.`shop_id`=t6.`shop_id` and t3.`date`=t6.`date` where t4.`city_market_id`<>9 ;

drop table if exists temp.dws_pangge_shop_allot_daily_temp3 ;
create table if not exists temp.dws_pangge_shop_allot_daily_temp3 as select `date`,-1 as `city_market_id`,-1 as `market_id`,-1 as `is_coo_shop`,-1 as `shop_id`,count(distinct (case when `is_coo_shop`=1 then `shop_id` else null end)) as `coo_shop_num`,count(distinct (case when `indicator` in ('enallot', 'print') then `shop_id` else null end)) as `neallot_shop_num`,count(case when `indicator`='allot' then 1 else null end) as `allot_item_num`,count(case when `indicator`='print' then 1 else null end) as `print_item_num`,count(case when `indicator`='enallot' then 1 else null end) as `enallot_item_num`  from temp.dws_pangge_shop_allot_daily_temp2 group by `date`  union all select `date`,-1 as `city_market_id`,-1 as `market_id`,-1 as `is_coo_shop`,`shop_id`,count(distinct (case when `is_coo_shop`=1 then `shop_id` else null end)) as `coo_shop_num`,count(distinct (case when `indicator` in ('enallot', 'print') then `shop_id` else null end)) as `neallot_shop_num`,count(case when `indicator`='allot' then 1 else null end) as `allot_item_num`,count(case when `indicator`='print' then 1 else null end) as `print_item_num`,count(case when `indicator`='enallot' then 1 else null end) as `enallot_item_num`  from temp.dws_pangge_shop_allot_daily_temp2 group by `date`,`shop_id`  union all select `date`,-1 as `city_market_id`,-1 as `market_id`,`is_coo_shop`,-1 as `shop_id`,count(distinct (case when `is_coo_shop`=1 then `shop_id` else null end)) as `coo_shop_num`,count(distinct (case when `indicator` in ('enallot', 'print') then `shop_id` else null end)) as `neallot_shop_num`,count(case when `indicator`='allot' then 1 else null end) as `allot_item_num`,count(case when `indicator`='print' then 1 else null end) as `print_item_num`,count(case when `indicator`='enallot' then 1 else null end) as `enallot_item_num`  from temp.dws_pangge_shop_allot_daily_temp2 group by `date`,`is_coo_shop`  union all select `date`,-1 as `city_market_id`,-1 as `market_id`,`is_coo_shop`,`shop_id`,count(distinct (case when `is_coo_shop`=1 then `shop_id` else null end)) as `coo_shop_num`,count(distinct (case when `indicator` in ('enallot', 'print') then `shop_id` else null end)) as `neallot_shop_num`,count(case when `indicator`='allot' then 1 else null end) as `allot_item_num`,count(case when `indicator`='print' then 1 else null end) as `print_item_num`,count(case when `indicator`='enallot' then 1 else null end) as `enallot_item_num`  from temp.dws_pangge_shop_allot_daily_temp2 group by `date`,`is_coo_shop`,`shop_id`  union all select `date`,-1 as `city_market_id`,`market_id`,-1 as `is_coo_shop`,-1 as `shop_id`,count(distinct (case when `is_coo_shop`=1 then `shop_id` else null end)) as `coo_shop_num`,count(distinct (case when `indicator` in ('enallot', 'print') then `shop_id` else null end)) as `neallot_shop_num`,count(case when `indicator`='allot' then 1 else null end) as `allot_item_num`,count(case when `indicator`='print' then 1 else null end) as `print_item_num`,count(case when `indicator`='enallot' then 1 else null end) as `enallot_item_num`  from temp.dws_pangge_shop_allot_daily_temp2 group by `date`,`market_id`  union all select `date`,-1 as `city_market_id`,`market_id`,-1 as `is_coo_shop`,`shop_id`,count(distinct (case when `is_coo_shop`=1 then `shop_id` else null end)) as `coo_shop_num`,count(distinct (case when `indicator` in ('enallot', 'print') then `shop_id` else null end)) as `neallot_shop_num`,count(case when `indicator`='allot' then 1 else null end) as `allot_item_num`,count(case when `indicator`='print' then 1 else null end) as `print_item_num`,count(case when `indicator`='enallot' then 1 else null end) as `enallot_item_num`  from temp.dws_pangge_shop_allot_daily_temp2 group by `date`,`market_id`,`shop_id`  union all select `date`,-1 as `city_market_id`,`market_id`,`is_coo_shop`,-1 as `shop_id`,count(distinct (case when `is_coo_shop`=1 then `shop_id` else null end)) as `coo_shop_num`,count(distinct (case when `indicator` in ('enallot', 'print') then `shop_id` else null end)) as `neallot_shop_num`,count(case when `indicator`='allot' then 1 else null end) as `allot_item_num`,count(case when `indicator`='print' then 1 else null end) as `print_item_num`,count(case when `indicator`='enallot' then 1 else null end) as `enallot_item_num`  from temp.dws_pangge_shop_allot_daily_temp2 group by `date`,`market_id`,`is_coo_shop`  union all select `date`,-1 as `city_market_id`,`market_id`,`is_coo_shop`,`shop_id`,count(distinct (case when `is_coo_shop`=1 then `shop_id` else null end)) as `coo_shop_num`,count(distinct (case when `indicator` in ('enallot', 'print') then `shop_id` else null end)) as `neallot_shop_num`,count(case when `indicator`='allot' then 1 else null end) as `allot_item_num`,count(case when `indicator`='print' then 1 else null end) as `print_item_num`,count(case when `indicator`='enallot' then 1 else null end) as `enallot_item_num`  from temp.dws_pangge_shop_allot_daily_temp2 group by `date`,`market_id`,`is_coo_shop`,`shop_id`  union all select `date`,`city_market_id`,-1 as `market_id`,-1 as `is_coo_shop`,-1 as `shop_id`,count(distinct (case when `is_coo_shop`=1 then `shop_id` else null end)) as `coo_shop_num`,count(distinct (case when `indicator` in ('enallot', 'print') then `shop_id` else null end)) as `neallot_shop_num`,count(case when `indicator`='allot' then 1 else null end) as `allot_item_num`,count(case when `indicator`='print' then 1 else null end) as `print_item_num`,count(case when `indicator`='enallot' then 1 else null end) as `enallot_item_num`  from temp.dws_pangge_shop_allot_daily_temp2 group by `date`,`city_market_id`  union all select `date`,`city_market_id`,-1 as `market_id`,-1 as `is_coo_shop`,`shop_id`,count(distinct (case when `is_coo_shop`=1 then `shop_id` else null end)) as `coo_shop_num`,count(distinct (case when `indicator` in ('enallot', 'print') then `shop_id` else null end)) as `neallot_shop_num`,count(case when `indicator`='allot' then 1 else null end) as `allot_item_num`,count(case when `indicator`='print' then 1 else null end) as `print_item_num`,count(case when `indicator`='enallot' then 1 else null end) as `enallot_item_num`  from temp.dws_pangge_shop_allot_daily_temp2 group by `date`,`city_market_id`,`shop_id`  union all select `date`,`city_market_id`,-1 as `market_id`,`is_coo_shop`,-1 as `shop_id`,count(distinct (case when `is_coo_shop`=1 then `shop_id` else null end)) as `coo_shop_num`,count(distinct (case when `indicator` in ('enallot', 'print') then `shop_id` else null end)) as `neallot_shop_num`,count(case when `indicator`='allot' then 1 else null end) as `allot_item_num`,count(case when `indicator`='print' then 1 else null end) as `print_item_num`,count(case when `indicator`='enallot' then 1 else null end) as `enallot_item_num`  from temp.dws_pangge_shop_allot_daily_temp2 group by `date`,`city_market_id`,`is_coo_shop`  union all select `date`,`city_market_id`,-1 as `market_id`,`is_coo_shop`,`shop_id`,count(distinct (case when `is_coo_shop`=1 then `shop_id` else null end)) as `coo_shop_num`,count(distinct (case when `indicator` in ('enallot', 'print') then `shop_id` else null end)) as `neallot_shop_num`,count(case when `indicator`='allot' then 1 else null end) as `allot_item_num`,count(case when `indicator`='print' then 1 else null end) as `print_item_num`,count(case when `indicator`='enallot' then 1 else null end) as `enallot_item_num`  from temp.dws_pangge_shop_allot_daily_temp2 group by `date`,`city_market_id`,`is_coo_shop`,`shop_id`  union all select `date`,`city_market_id`,`market_id`,-1 as `is_coo_shop`,-1 as `shop_id`,count(distinct (case when `is_coo_shop`=1 then `shop_id` else null end)) as `coo_shop_num`,count(distinct (case when `indicator` in ('enallot', 'print') then `shop_id` else null end)) as `neallot_shop_num`,count(case when `indicator`='allot' then 1 else null end) as `allot_item_num`,count(case when `indicator`='print' then 1 else null end) as `print_item_num`,count(case when `indicator`='enallot' then 1 else null end) as `enallot_item_num`  from temp.dws_pangge_shop_allot_daily_temp2 group by `date`,`city_market_id`,`market_id`  union all select `date`,`city_market_id`,`market_id`,-1 as `is_coo_shop`,`shop_id`,count(distinct (case when `is_coo_shop`=1 then `shop_id` else null end)) as `coo_shop_num`,count(distinct (case when `indicator` in ('enallot', 'print') then `shop_id` else null end)) as `neallot_shop_num`,count(case when `indicator`='allot' then 1 else null end) as `allot_item_num`,count(case when `indicator`='print' then 1 else null end) as `print_item_num`,count(case when `indicator`='enallot' then 1 else null end) as `enallot_item_num`  from temp.dws_pangge_shop_allot_daily_temp2 group by `date`,`city_market_id`,`market_id`,`shop_id`  union all select `date`,`city_market_id`,`market_id`,`is_coo_shop`,-1 as `shop_id`,count(distinct (case when `is_coo_shop`=1 then `shop_id` else null end)) as `coo_shop_num`,count(distinct (case when `indicator` in ('enallot', 'print') then `shop_id` else null end)) as `neallot_shop_num`,count(case when `indicator`='allot' then 1 else null end) as `allot_item_num`,count(case when `indicator`='print' then 1 else null end) as `print_item_num`,count(case when `indicator`='enallot' then 1 else null end) as `enallot_item_num`  from temp.dws_pangge_shop_allot_daily_temp2 group by `date`,`city_market_id`,`market_id`,`is_coo_shop`  union all select `date`,`city_market_id`,`market_id`,`is_coo_shop`,`shop_id`,count(distinct (case when `is_coo_shop`=1 then `shop_id` else null end)) as `coo_shop_num`,count(distinct (case when `indicator` in ('enallot', 'print') then `shop_id` else null end)) as `neallot_shop_num`,count(case when `indicator`='allot' then 1 else null end) as `allot_item_num`,count(case when `indicator`='print' then 1 else null end) as `print_item_num`,count(case when `indicator`='enallot' then 1 else null end) as `enallot_item_num`  from temp.dws_pangge_shop_allot_daily_temp2 group by `date`,`city_market_id`,`market_id`,`is_coo_shop`,`shop_id`  ;

drop table if exists temp.dws_pangge_shop_allot_daily_temp4 ;
create table if not exists temp.dws_pangge_shop_allot_daily_temp4 as select t1.* ,(case when t1.`city_market_id`=-1 then '总体' else t3.`name` end) as `city_market_name` ,(case when t1.`market_id`=-1 then '总体' else t4.`subname` end) as `market_name` ,(case when t1.`shop_id`=-1 then '总体' else t2.`name` end) as `shop_name` from temp.dws_pangge_shop_allot_daily_temp3 t1 left join ods.t_shop t2 on t1.`shop_id`=t2.`id` left join ods.t_city_market t3 on t1.`city_market_id`=t3.`id` left join ods.t_market t4 on t1.`market_id`=t4.`subbid` ;

insert overwrite table dws.dws_pangge_shop_allot_daily partition(`date`='${hivevar:day}') select `city_market_id` ,`city_market_name` ,`market_id` ,`market_name` ,`is_coo_shop` ,`shop_id` ,`shop_name` ,`coo_shop_num` ,`neallot_shop_num` ,`allot_item_num` ,`print_item_num` ,`enallot_item_num` from temp.dws_pangge_shop_allot_daily_temp4 where `date`='${hivevar:day}' ;

