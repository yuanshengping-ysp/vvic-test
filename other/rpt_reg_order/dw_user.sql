SET hive.mapred.supports.subdirectories=TRUE;
SET mapred.input.dir.recursive=TRUE;


drop table if exists temp.why_dw_user ;
create table temp.why_dw_user as select substring(t1.register_date,1,10) as reg_date ,t1.id as user_id ,t1.register_date as reg_time ,(case when t2.device_channel=1 then 'web' when t2.device_channel=2 then 'm' when t2.device_channel=3 then 'app' when t2.device_channel=4 then 'app' when t2.device_channel is null and t3.os is not null then 'app' when t2.device_channel is null and t3.os is null and t1.register_endpoint=1 then 'web' when t2.device_channel is null and t3.os is null and t1.register_endpoint=2 then 'app' when t2.device_channel is null and t3.os is null and t1.register_endpoint=4 then 'app' when t2.device_channel is null and t3.os is null and t1.register_endpoint=3 then 'm' else 'web' end) as reg_terminal ,(case when t4.shop_id is null then '买手用户' else '档口用户' end) as is_shop_user from (select id,register_date,register_endpoint,mobile from ods.t_user where register_date<date_add('${hivevar:day}',1)) t1 left join (select user_id,device_channel,create_time from ods.t_user_device_bind where create_time<date_add('${hivevar:day}',1)) t2 on t1.id=t2.user_id and t1.register_date=t2.create_time left join (select * from ods.t_app_register where ctime<date_add('${hivevar:day}',1)) t3 on t1.mobile=t3.mobile and t1.register_date=t3.ctime left join (select id as shop_id ,user_id from ods.t_shop) t4 on t1.id=t4.user_id where t1.id is not null ;
