SET hive.mapred.supports.subdirectories=TRUE;
SET mapred.input.dir.recursive=TRUE;


drop table if exists temp.vvic_order_merge_temp0 ;
create table if not exists temp.vvic_order_merge_temp0 as select order_id ,order_no ,pay_no ,user_id ,user_name ,user_mobile ,consignee ,country ,country_id ,province ,province_id ,city ,city_id ,area ,area_id ,address ,zipcode ,tel ,mobile ,email ,postscript ,shipper_name ,shipper_mobile ,pay_id ,pay_name ,express_id ,express_no ,express_code ,express_type ,express_name ,express_pack_no ,express_fee ,express_branch_id ,branch_code ,branch_name ,apply_for_return ,initial_count ,is_deleted ,purchase_fee ,handling_fee ,add_amount ,refund_amount ,return_amount ,goods_amount ,paid_amount ,order_amount ,order_status ,time_out ,create_time ,confirm_time ,pay_time ,shipping_time ,update_time ,vesion ,terminal ,out_order_no ,origin ,order_flag ,out_order_id ,bid ,city_market_id ,city_market_code ,delay_days ,delivery_time ,packing_fee ,gift_fee ,check_quality_fee ,unit_purchase_fee ,unit_check_quality_fee ,unit_handling_fee ,purchase_service_id ,check_quality_service_id ,cancel_purchase_fee ,cancel_handling_fee ,cancel_check_quality_fee ,order_type ,express_fee_discount ,platform_serv_fee ,platform_serv_fee_id ,cancel_platform_serv_fee ,1 as table_type from ods.vvic_order_subject union all select order_id ,order_no ,pay_no ,user_id ,user_name ,user_mobile ,consignee ,country ,country_id ,province ,province_id ,city ,city_id ,area ,area_id ,address ,zipcode ,tel ,mobile ,email ,postscript ,shipper_name ,shipper_mobile ,pay_id ,pay_name ,express_id ,express_no ,express_code ,express_type ,express_name ,express_pack_no ,express_fee ,express_branch_id ,branch_code ,branch_name ,apply_for_return ,initial_count ,is_deleted ,purchase_fee ,handling_fee ,add_amount ,refund_amount ,return_amount ,goods_amount ,paid_amount ,order_amount ,order_status ,time_out ,create_time ,confirm_time ,pay_time ,shipping_time ,update_time ,vesion ,terminal ,null as out_order_no ,null as origin ,null as order_flag ,null as out_order_id ,null as bid ,1 as city_market_id ,'gz' as city_market_code ,null as delay_days ,null as delivery_time ,null as packing_fee ,null as gift_fee ,null as check_quality_fee ,null as unit_purchase_fee ,null as unit_check_quality_fee ,null as unit_handling_fee ,null as purchase_service_id ,null as check_quality_service_id ,null as cancel_purchase_fee ,null as cancel_handling_fee ,null as cancel_check_quality_fee ,0 as order_type ,null as express_fee_discount ,null as platform_serv_fee ,null as platform_serv_fee_id ,null as cancel_platform_serv_fee ,2 as table_type from ods.ods__vvic_order_201803 union all select order_id ,order_no ,pay_no ,user_id ,user_name ,user_mobile ,consignee ,country ,country_id ,province ,province_id ,city ,city_id ,area ,area_id ,address ,zipcode ,tel ,mobile ,email ,postscript ,shipper_name ,shipper_mobile ,pay_id ,pay_name ,express_id ,express_no ,express_code ,express_type ,express_name ,express_pack_no ,express_fee ,express_branch_id ,branch_code ,branch_name ,apply_for_return ,initial_count ,is_deleted ,purchase_fee ,handling_fee ,add_amount ,refund_amount ,return_amount ,goods_amount ,paid_amount ,order_amount ,order_status ,time_out ,create_time ,confirm_time ,pay_time ,shipping_time ,update_time ,vesion ,'pc' as terminal ,null as out_order_no ,null as origin ,null as order_flag ,null as out_order_id ,null as bid ,1 as city_market_id ,'gz' as city_market_code ,null as delay_days ,null as delivery_time ,null as packing_fee ,null as gift_fee ,null as check_quality_fee ,null as unit_purchase_fee ,null as unit_check_quality_fee ,null as unit_handling_fee ,null as purchase_service_id ,null as check_quality_service_id ,null as cancel_purchase_fee ,null as cancel_handling_fee ,null as cancel_check_quality_fee ,0 as order_type ,null as express_fee_discount ,null as platform_serv_fee ,null as platform_serv_fee_id ,null as cancel_platform_serv_fee ,3 as table_type from ods.ods__vvic_order_archive ;

drop table if exists temp.vvic_order_merge_temp1 ;
create table if not exists temp.vvic_order_merge_temp1 as select * ,first_value(table_type) over (partition by order_id order by table_type) as first_table_type from temp.vvic_order_merge_temp0 ;

drop table if exists temp.vvic_order_merge_temp2 ;
create table if not exists temp.vvic_order_merge_temp2 as select * ,date_add('${hivevar:day}',1) as update_date from temp.vvic_order_merge_temp1 where table_type=first_table_type ;

insert overwrite table ods.vvic_order_merge select order_id ,order_no ,pay_no ,user_id ,user_name ,user_mobile ,consignee ,country ,country_id ,province ,province_id ,city ,city_id ,area ,area_id ,address ,zipcode ,tel ,mobile ,email ,postscript ,shipper_name ,shipper_mobile ,pay_id ,pay_name ,express_id ,express_no ,express_code ,express_type ,express_name ,express_pack_no ,express_fee ,express_branch_id ,branch_code ,branch_name ,apply_for_return ,initial_count ,is_deleted ,purchase_fee ,handling_fee ,add_amount ,refund_amount ,return_amount ,goods_amount ,paid_amount ,order_amount ,order_status ,time_out ,create_time ,confirm_time ,pay_time ,shipping_time ,update_time ,vesion ,terminal ,out_order_no ,origin ,order_flag ,out_order_id ,bid ,city_market_id ,city_market_code ,delay_days ,delivery_time ,packing_fee ,gift_fee ,check_quality_fee ,unit_purchase_fee ,unit_check_quality_fee ,unit_handling_fee ,purchase_service_id ,check_quality_service_id ,cancel_purchase_fee ,cancel_handling_fee ,cancel_check_quality_fee ,order_type ,express_fee_discount ,platform_serv_fee ,platform_serv_fee_id ,cancel_platform_serv_fee ,update_date from temp.vvic_order_merge_temp2 ;
